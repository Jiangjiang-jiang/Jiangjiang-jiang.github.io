<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <link rel="alternate icon" type="image/png" href="/img/favicon.png">
    <title>姜姜酱 | </title>
    
<link rel="stylesheet" href="/css/reset.css">

    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/css/markdown.css">

    
<link rel="stylesheet" href="/css/fonts.css">

<meta name="generator" content="Hexo 6.1.0"></head>
    <body>
        <div class="paper">
            <div class="paper-main">
                
                    <div class="post-header">
    <a class="logo" href="/">姜姜酱</a>
    <a class="go-home" href="/">
        <svg width="8" height="14" viewBox="0 0 8 14">
            <path d="M7 1L1 7l6 6" stroke="#000" stroke-width="2" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </a>
</div>
                
                <div class="post-main">

    
        <div class="post-main-title">
            2021华为计算AI安全冬令营crypto writeup
        </div>
        <div class="post-meta">
            2021-01-09
        </div>
    

    <div class="post-md">
        <p>crypto writeup</p>
<span id="more"></span>

<h2 id="古典美"><a href="#古典美" class="headerlink" title="古典美"></a>古典美</h2><p>密钥：VklHRU5FUkU&#x3D;</p>
<p>密文：</p>
<p>HHCKPDQEGUFXFCKHBZXXVQAAHZYHVDSYBQEHXRUHHCEXXSADBGEXZRCHBYEHTBAEH4GJEMFS</p>
<p>密钥用base64解码：VIGENERE，作为维吉尼亚的密钥。</p>
<p>解密密文得到：</p>
<p>MZWGCZZALMZTSYTDGRRTIMJWMRSDIZBUGIYDKNDDMUYTKOJZGYYTMNLDGQYDGXJAM4YDAZBB</p>
<p>只有A-Z和数字，因此采用base32解码： flag [39bc4c416dd4d42054ce15996165c403] g00d! </p>
<h2 id="忘记题目"><a href="#忘记题目" class="headerlink" title="(忘记题目)"></a>(忘记题目)</h2><p>题目考察的点是在RSA中，如果已知公钥对(e, n)对应的私钥对(d, n)，有办法分解出p, q的值。参考<a target="_blank" rel="noopener" href="https://www.di-mgt.com.au/rsa_factorize_n.html">https://www.di-mgt.com.au/rsa_factorize_n.html</a></p>
<p>这道题首先第一部分用正常的d解密就好：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">d1=<span class="number">0x7d12e57b1aa157038ebe5c45b56256270671e6984b0dcdf10a2ea07ce480143240c9a3e1c60870e499306a717073f157476aa88e99a7bdf1e2a4adf8ce21025cc6c05035c4a1d7e3b6f061464872e65118384999f0154f3c1761fa68d4685126b7fc98f4c2cdc41c98aa4e099a868a89099dd2170664647efca2c8d8e06a2e49</span></span><br><span class="line">e1=<span class="number">0x10001</span></span><br><span class="line">n1=<span class="number">0x96ed2727e4446e26c84552a9a19640c7d720c9b6e661cfcfec03463e92a9d0b228ddc9847c0daa137a19db67294626c535fe71c388f6ea3eb8cb5dbf09a84374eb021c9297a29394cf77da157c1b8be77b09a4fcbe54bf3dc93d33539e842766ad8e38369093ddc034ac32583a48e299a4d8b31b606b1729298ee136664b8b77</span></span><br><span class="line">c1=<span class="number">0x6c435db37217bc4da3f225a8f1a0501e03a97d2cbc4fa249df051ed66c1559b68885f4fa181bdd9e98242441f463dbbc1c26d1eea2c5774a0a905b366c8775bce8e52182dc32a93647c9b8842b74abc434e5b84eeae679a3b19cb7a1ef6ae8f65d22ce6ab438a16119805eee83408a68207bbdfde5181a8bd8b4794c711d33c4</span></span><br><span class="line">m1=<span class="built_in">pow</span>(c1, d1, n1)</span><br><span class="line">long_to_bytes(m1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &#x27;flag part one is :2295b774c4467c9a&#x27;</span></span><br></pre></td></tr></table></figure>

<p>再由e,d,n分解出p,q。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.math.BigInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KnownEDN</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> BigInteger[] attack(BigInteger e, BigInteger d, BigInteger n) &#123;</span><br><span class="line">        BigInteger[] result = <span class="keyword">new</span> <span class="title class_">BigInteger</span>[<span class="number">2</span>];</span><br><span class="line">        <span class="type">BigInteger</span> <span class="variable">k</span> <span class="operator">=</span> d.multiply(e).subtract(BigInteger.ONE);</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">BigInteger</span> <span class="variable">g</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigInteger</span>(n.bitLength(), random);</span><br><span class="line">            <span class="keyword">while</span> (g.compareTo(BigInteger.ONE) &lt;= <span class="number">0</span> || g.compareTo(n) &gt;= <span class="number">0</span>)</span><br><span class="line">                g = <span class="keyword">new</span> <span class="title class_">BigInteger</span>(n.bitLength(), random);</span><br><span class="line">            <span class="type">BigInteger</span> <span class="variable">k1</span> <span class="operator">=</span> k;</span><br><span class="line">            <span class="keyword">while</span> (k1.mod(BigInteger.TWO).equals(BigInteger.ZERO)) &#123;</span><br><span class="line">                k1 = k1.shiftRight(<span class="number">1</span>);</span><br><span class="line">                <span class="type">BigInteger</span> <span class="variable">x</span> <span class="operator">=</span> g.modPow(k1, n);</span><br><span class="line">                result[<span class="number">0</span>] = x.subtract(BigInteger.ONE).gcd(n);</span><br><span class="line">                <span class="keyword">if</span> (x.compareTo(BigInteger.ONE) &gt; <span class="number">0</span> &amp;&amp; result[<span class="number">0</span>].compareTo(BigInteger.ONE) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    result[<span class="number">1</span>] = n.divide(result[<span class="number">0</span>]);</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">BigInteger</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="string">&quot;65537&quot;</span>);</span><br><span class="line">        <span class="type">BigInteger</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">        <span class="title class_">BigInteger</span>(<span class="string">&quot;87829819124646652739812957863722412015634891260772294325995961099107534010712036077168547772778499478512604716421195336244466016654383871260966997679029170319388738640308348628385235411655710226519739834339519380578327359429189610559253693055613763347244887191660768249285720137254760097622936841830552710729&quot;</span>);</span><br><span class="line">        <span class="type">BigInteger</span> <span class="variable">n</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">        <span class="title class_">BigInteger</span>(<span class="string">&quot;105984107381045601823003108385313761784328476156897016317924496005453968007586579300498888169700143991517014514556827875595249016469561521069948889302177015514105662236342493793950683120435606323771328483886206142440957804487985287339927632655132795619465387151256885471251176082064948939517064310791867173751&quot;</span>);</span><br><span class="line">        BigInteger[] pq = attack(e, d, n);</span><br><span class="line">        System.out.println(<span class="string">&quot;p:\n&quot;</span> + pq[<span class="number">0</span>] + <span class="string">&quot;\nq:\n&quot;</span> + pq[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从而得到p,q的值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"></span><br><span class="line">p = <span class="number">7989817345872802916258824633068986429227729563110196898659568255235293257271203068952971618219681106634429039565231866429796385557747877260629666332312643</span></span><br><span class="line">q = <span class="number">13264897405419718100411551025228233248810511685104073408647554593159408298020238756835088759200259612491893289998541138751171701279712972233358298687021757</span></span><br><span class="line">c2 = <span class="number">0x8cb5d8861e5838f41910d6eaf142a8d47b92e0c6b1b1e9e25896f7169644bbb726ccfdc82ba50932fbc45f00c53dda42f8efc358a5108cde8aaa9f38b493aa3417c9522924f06847ba4a3dd26f005a610f7633877fbe89e090df5cb3a7a5ebae0fbe72eabb339b21fa2ddd33844a5cb53e39491fc472721ed676ae07b33c8d6e</span></span><br><span class="line">phi = (p - <span class="number">1</span>) * (q - <span class="number">1</span>)</span><br><span class="line">e = <span class="number">0x3f1</span></span><br><span class="line">d = gmpy2.invert(e, phi)</span><br><span class="line">m = <span class="built_in">pow</span>(c2, d, p*q)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(m))</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag part two is :ca5c600783b9bde0</span></span><br></pre></td></tr></table></figure>

<p>两部分连接起来就是flag的值。</p>
<h2 id="RSA-upgrade"><a href="#RSA-upgrade" class="headerlink" title="RSA_upgrade"></a>RSA_upgrade</h2><p>题目代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> sympy <span class="keyword">import</span> nextprime</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> *</span><br><span class="line">flag = <span class="string">b&#x27;DASCTF&#123;********************************&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lcg</span>(<span class="params">seed,params</span>):</span><br><span class="line">    (m,c,n)=params</span><br><span class="line">    s = seed % n</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        s = (m * s + c) % n</span><br><span class="line">        <span class="keyword">yield</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">seed = getPrime(<span class="number">128</span>)</span><br><span class="line">m = getPrime(<span class="number">128</span>)</span><br><span class="line">c = getPrime(<span class="number">128</span>)</span><br><span class="line">n = getPrime(<span class="number">129</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">key_stream = lcg(seed,(m,c,n))</span><br><span class="line">num=[]</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">	num.append(<span class="built_in">next</span>(key_stream))</span><br><span class="line"></span><br><span class="line">secret =  <span class="built_in">next</span>(key_stream)</span><br><span class="line"></span><br><span class="line">e = nextprime(secret)</span><br><span class="line">p = getPrime(<span class="number">1024</span>)</span><br><span class="line">q = getPrime(<span class="number">1024</span>)</span><br><span class="line">r = getPrime(<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag = bytes_to_long(flag)</span><br><span class="line">flag ^= flag &gt;&gt; <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(p)</span><br><span class="line"><span class="built_in">print</span>(p*q*r)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">pow</span>(flag,e,p*q*r))</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">num = [<span class="number">58605992502479537155943965904595921273</span>, <span class="number">525605798656979919420608964379033982804</span>, <span class="number">607738431135489138748992347244318940466</span>, <span class="number">631747898536603358381419028993140907216</span>, <span class="number">13450658701001781564543219325486287717</span>, <span class="number">407826262741495712819054543462943222370</span>]</span><br><span class="line">p = <span class="number">138092450043978032187397495330379791355629274237204650898232878263413301988536751004632087169676028049236253598677819980191406826529664613957150122788435561338344715937422320958238628877093605040078776555586363593650646481242888908171897232624141894446324625781720275455534977357099473212936612966142541689717</span></span><br><span class="line">newN = <span class="number">3373500409784821814490131118443028295231446638918191872866826078664586857545499510115664725311697632345156866795088640886074708893049896293408277232121045205172588091316164743124173177747110069553394872128870505076277498830601152723565030932360665298864122468812389923295873644041292977470736981439616767671752225297169001703767163460419431015014012924743881828753765788455996503018031103917461875346904941302752301152097427368052588291798732671143344833211267818507324812463058368199324367285019651028003000765054679485233317767201747568717493732406861626561470103436488978595267326521876995116542475030869904228103019888619123275263009931569375612626796485751453790231029224398879558668919940829341599982045260085645733137064910612640851525128951165660322666651603943749615559507563880191545144231282875004494643666234781231448702811026047613232622993307630737999918058511598922102840862761604680588858313364100914751476403</span></span><br><span class="line">c = <span class="number">40522976224675404992818282038409183193065303107530049168092540620105120083552580372904554927069109321998620410524986748598618388761467715127564839742806614159382512978830563949967053562802375030363283879451081474764301602860367140250483857874335594802704634427276762179861996608105102610424633434334897307449739846880323406404392707133580686043181007091235341464802410874449708870610192494627811013526751435468963111672237058189288520084494533786573065843704621915085789731723587760910378534773137633519620193203450046994466154848079413319979993890764583887936777316159487010002407093187269512820453207591173395762513970799972839858119501585885277954258269483363133460240339866272358522431904252286259542327658731232568465990008278265227086114042064326334937705758042097987623388556184022737180944807660792992413039097516526454455063218161704505837882378018400687043158628503465274374703624257222504948612055237771581019005</span></span><br></pre></td></tr></table></figure>

<p>典型的m,c,n未知时候的LCG。首先求出m,c,n及seed的值，有多个可能的值，代回原来的lcg函数比对生成的6个值。具体公式推导见 <a target="_blank" rel="noopener" href="https://blog.csdn.net/superprintf/article/details/108964563">https://blog.csdn.net/superprintf/article/details/108964563</a> (写的真不错)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gcd</span>(<span class="params">a,b</span>): </span><br><span class="line">    <span class="keyword">if</span>(b == <span class="number">0</span>): </span><br><span class="line">        <span class="keyword">return</span> a </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        <span class="keyword">return</span> gcd(b,a % b) </span><br><span class="line"></span><br><span class="line">s =  [<span class="number">58605992502479537155943965904595921273</span>, <span class="number">525605798656979919420608964379033982804</span>, <span class="number">607738431135489138748992347244318940466</span>, <span class="number">631747898536603358381419028993140907216</span>, <span class="number">13450658701001781564543219325486287717</span>, <span class="number">407826262741495712819054543462943222370</span>]</span><br><span class="line">t = []</span><br><span class="line">all_n = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    t.append(s[i] - s[i - <span class="number">1</span>]) </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    all_n.append(gcd((t[i + <span class="number">1</span>] * t[i - <span class="number">1</span>] - t[i] * t[i]), (t[i + <span class="number">2</span>] * t[i] - t[i + <span class="number">1</span>] * t[i + <span class="number">1</span>]))) </span><br><span class="line"></span><br><span class="line">MMI = <span class="keyword">lambda</span> A, n, s=<span class="number">1</span>, t=<span class="number">0</span>, N=<span class="number">0</span>: (n &lt; <span class="number">2</span> <span class="keyword">and</span> t % N <span class="keyword">or</span> MMI(n, A % n, t, s - A // n * t, N <span class="keyword">or</span> n), -<span class="number">1</span>)[n &lt; <span class="number">1</span>]</span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> all_n:</span><br><span class="line">    n = <span class="built_in">abs</span>(n)</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    m = (s[<span class="number">2</span>] - s[<span class="number">1</span>]) * MMI((s[<span class="number">1</span>] - s[<span class="number">0</span>]), n) % n</span><br><span class="line">    ani = MMI(m,n)</span><br><span class="line">    c = (s[<span class="number">1</span>] - m * s[<span class="number">0</span>]) % n</span><br><span class="line">    seed = (ani * (s[<span class="number">0</span>] - c)) % n</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;n = &quot;</span>,n)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;m = &quot;</span>,m)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;c = &quot;</span>,c)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;seed = &quot;</span>,seed)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># n =  658483278832814360413959491304994965751</span></span><br><span class="line"><span class="comment"># m =  304895213771629215412875483024241040557</span></span><br><span class="line"><span class="comment"># c =  332633353219222389093389121471714482887</span></span><br><span class="line"><span class="comment"># seed =  233122372118782757817692638408531340431</span></span><br></pre></td></tr></table></figure>

<p>e是lcg的第7个值的下一质数，这样就能得出e。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> sympy <span class="keyword">import</span> nextprime</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">n =  <span class="number">658483278832814360413959491304994965751</span></span><br><span class="line">m =  <span class="number">304895213771629215412875483024241040557</span></span><br><span class="line">c =  <span class="number">332633353219222389093389121471714482887</span></span><br><span class="line">seed =  <span class="number">233122372118782757817692638408531340431</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lcg</span>(<span class="params">seed,params</span>):</span><br><span class="line">    (m,c,n)=params</span><br><span class="line">    s = seed % n</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        s = (m * s + c) % n</span><br><span class="line">        <span class="keyword">yield</span> s</span><br><span class="line"></span><br><span class="line">key_stream = lcg(seed,(m,c,n))</span><br><span class="line">num=[]</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">	num.append(<span class="built_in">next</span>(key_stream))</span><br><span class="line"></span><br><span class="line">secret =  <span class="built_in">next</span>(key_stream)</span><br><span class="line">e = nextprime(secret)</span><br><span class="line"></span><br><span class="line"><span class="comment"># e = 176683449265430137948016253982177600477</span></span><br></pre></td></tr></table></figure>

<p>发现是三质数的RSA。这里有个坑，跟BMZCTF2020里一样。因为p,q,r两两互素，所以不需要知道q,r的值，利用phi(p)&#x3D;p-1就可以得到d的值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line">p = <span class="number">138092450043978032187397495330379791355629274237204650898232878263413301988536751004632087169676028049236253598677819980191406826529664613957150122788435561338344715937422320958238628877093605040078776555586363593650646481242888908171897232624141894446324625781720275455534977357099473212936612966142541689717</span></span><br><span class="line">c = <span class="number">40522976224675404992818282038409183193065303107530049168092540620105120083552580372904554927069109321998620410524986748598618388761467715127564839742806614159382512978830563949967053562802375030363283879451081474764301602860367140250483857874335594802704634427276762179861996608105102610424633434334897307449739846880323406404392707133580686043181007091235341464802410874449708870610192494627811013526751435468963111672237058189288520084494533786573065843704621915085789731723587760910378534773137633519620193203450046994466154848079413319979993890764583887936777316159487010002407093187269512820453207591173395762513970799972839858119501585885277954258269483363133460240339866272358522431904252286259542327658731232568465990008278265227086114042064326334937705758042097987623388556184022737180944807660792992413039097516526454455063218161704505837882378018400687043158628503465274374703624257222504948612055237771581019005</span></span><br><span class="line">phi = p - <span class="number">1</span></span><br><span class="line">e = <span class="number">176683449265430137948016253982177600477</span></span><br><span class="line">d = gmpy2.invert(e, phi)</span><br><span class="line">m = <span class="built_in">pow</span>(c, d, p)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 569987504250336203008383799281952855095298052417061158522700484233183317916824291767569080757872</span></span><br></pre></td></tr></table></figure>

<p>有了明文，但并不是真正的flag。明文是flag异或上flag &gt;&gt; 10的值，flag头部’DASCTF{‘，但只移动了10bits，因此理论上每10bit一组交替异或，可以逆推出flag的值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">m = <span class="number">569987504250336203008383799281952855095298052417061158522700484233183317916824291767569080757872</span></span><br><span class="line">flag = <span class="built_in">list</span>(<span class="built_in">bin</span>(m)[<span class="number">2</span>:])</span><br><span class="line">part = <span class="built_in">bin</span>(bytes_to_long(<span class="string">b&#x27;DASCTF&#123;&#x27;</span>))[<span class="number">2</span>:][:<span class="number">10</span>]</span><br><span class="line">result = [part]</span><br><span class="line">str1 = []</span><br><span class="line">str2 = [<span class="string">&#x27;0000000000&#x27;</span>, part]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(flag), <span class="number">10</span>):</span><br><span class="line">    t = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">str</span>(j) <span class="keyword">for</span> j <span class="keyword">in</span> flag[i:i+<span class="number">10</span>])</span><br><span class="line">    str1.append(t)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(str1)):</span><br><span class="line">    L = <span class="built_in">len</span>(str1[i])</span><br><span class="line">    tmp = str2[i][:L]</span><br><span class="line">    t = <span class="built_in">bin</span>(<span class="built_in">int</span>(str1[i], <span class="number">2</span>) ^ <span class="built_in">int</span>(tmp, <span class="number">2</span>))[<span class="number">2</span>:].zfill(L)</span><br><span class="line">    result.append(t)</span><br><span class="line">    str2.append(t)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join(result), <span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># DASCTF&#123;b19998fb5acd197e441029b37bc246d7&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="rsa4"><a href="#rsa4" class="headerlink" title="rsa4"></a>rsa4</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line">flag = <span class="string">&#x27;flag is :********************************&#x27;</span></span><br><span class="line">hex_flag=<span class="built_in">int</span>(flag.encode(<span class="string">&quot;hex&quot;</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">p=getPrime(<span class="number">256</span>)</span><br><span class="line">q=getPrime(<span class="number">256</span>)</span><br><span class="line">n=p*q</span><br><span class="line"></span><br><span class="line">e=<span class="number">0x3</span></span><br><span class="line"></span><br><span class="line">c=<span class="built_in">pow</span>(hex_flag,e,n)</span><br><span class="line"></span><br><span class="line">m=((hex_flag&gt;&gt;<span class="number">120</span>)&lt;&lt;<span class="number">120</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;n=&quot;</span>,<span class="built_in">hex</span>(n))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;e=&quot;</span>,<span class="built_in">hex</span>(e))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;c=&quot;</span>,<span class="built_in">hex</span>(c))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;m=&quot;</span>,<span class="built_in">hex</span>(m))</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">(&#x27;n=&#x27;, &#x27;0x8bc8479ebf10dc1a4c24d6dfd6effd0437969eebf67654bc5c495bf2577f15226c15b9793ce9363c5986c485c2932fc7e7e6daac8dc108cca6d1b3850353fa2fL&#x27;)</span></span><br><span class="line"><span class="string">(&#x27;e=&#x27;, &#x27;0x3&#x27;)</span></span><br><span class="line"><span class="string">(&#x27;c=&#x27;, &#x27;0x87c05b7868cf54a58e19fe7a969a0213101f045e2afbf7547534564e918b62caa8187c773a8168ff464b20c28ce0e33383a600351883bb0938b2ecf0c45d59f3L&#x27;)</span></span><br><span class="line"><span class="string">(&#x27;m=&#x27;, &#x27;0x666c6167206973203a3739306666373532653338393838613532000000000000000000000000000000L&#x27;)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>m是由flag向右移120后再向左移120位得到，m高位泄露，低位的120比特未知。加上e &#x3D; 3，可以联想到coopersmith的高位攻击。以前的coopersmith定理的题目一般是已知p的高位，爆破出完整的p来分解n。 sage里面的small_roots实现了LLL算法求解非线性低维度多项式方程小根的方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">n = <span class="number">0x8bc8479ebf10dc1a4c24d6dfd6effd0437969eebf67654bc5c495bf2577f15226c15b9793ce9363c5986c485c2932fc7e7e6daac8dc108cca6d1b3850353fa2f</span></span><br><span class="line">e = <span class="number">0x3</span></span><br><span class="line">c = <span class="number">0x87c05b7868cf54a58e19fe7a969a0213101f045e2afbf7547534564e918b62caa8187c773a8168ff464b20c28ce0e33383a600351883bb0938b2ecf0c45d59f3</span></span><br><span class="line">m_part = <span class="number">0x666c6167206973203a3739306666373532653338393838613532000000000000000000000000000000</span></span><br><span class="line"></span><br><span class="line">kbits = <span class="number">120</span></span><br><span class="line">PR.&lt;x&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">f = (m_part + x) ^ e - c</span><br><span class="line">x0 = f.small_roots(X=<span class="number">2</span>^kbits, beta=<span class="number">0.4</span>)[<span class="number">0</span>]</span><br><span class="line">m = m_part + x0</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(m))</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag is :790ff752e38988a521c73837942b1414</span></span><br></pre></td></tr></table></figure>

<h2 id="MEET"><a href="#MEET" class="headerlink" title="MEET"></a>MEET</h2><p>题目代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> DES</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">_2DES</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Get_key</span>(<span class="params">self</span>):</span><br><span class="line">        k1=<span class="string">&quot;&quot;</span>.join([random.choice(<span class="string">&#x27;0123456789abcdef&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)])</span><br><span class="line">        <span class="keyword">return</span> (k1[:<span class="number">4</span>]*<span class="number">2</span>,k1[<span class="number">4</span>:]*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Enc</span>(<span class="params">self,msg,key1,key2</span>):</span><br><span class="line">        k1,k2=key1,key2</span><br><span class="line">        e1=DES.new(k1.encode(),DES.MODE_CBC,<span class="built_in">bytes</span>(<span class="number">8</span>))</span><br><span class="line">        e2=DES.new(k2.encode(),DES.MODE_CBC,<span class="built_in">bytes</span>(<span class="number">8</span>))</span><br><span class="line">        c=e2.decrypt(e1.encrypt(msg))</span><br><span class="line">        <span class="keyword">return</span> base64.b64encode(c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    _2des=_2DES()</span><br><span class="line">    k1,k2=_2des.Get_key()</span><br><span class="line">    c=_2des.Enc(<span class="string">b&#x27;12345678&#x27;</span>,k1,k2)</span><br><span class="line">    <span class="built_in">print</span>(c)</span><br><span class="line">    c=_2des.Enc(flag,k1,k2)</span><br><span class="line">    <span class="built_in">print</span>(c)</span><br><span class="line"></span><br><span class="line"><span class="comment">#b&#x27;D4meWwYAUE4=&#x27;</span></span><br><span class="line"><span class="comment">#b&#x27;qMMGe3wORmFJePnQnM2ZeA==&#x27;</span></span><br></pre></td></tr></table></figure>

<p>2DES的中间相遇攻击。已知一组明密文[12345678, D4meWwYAUE4&#x3D;]，能够爆破出k1k2的值。满足：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c = e2.decrypt(e1.encrypt(msg))</span><br><span class="line">e2.encrypt(c) = e1.encrypt(msg)</span><br></pre></td></tr></table></figure>

<p>因此先遍历k1加密明文后的值放入一个数组1，再遍历k2加密密文c后的值放入数组2，比较数组1和数组2找相同的中间值，根据中间值计算对应的k1和k2。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> DES</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> itertools <span class="keyword">as</span> its</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enc</span>(<span class="params">msg,k</span>):</span><br><span class="line">    e=DES.new(k.encode(),DES.MODE_CBC,<span class="built_in">bytes</span>(<span class="number">8</span>))</span><br><span class="line">    c = e.encrypt(msg)</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dec</span>(<span class="params">c, key1, key2</span>):</span><br><span class="line">    k1, k2 = key1, key2</span><br><span class="line">    e1 = DES.new(k1.encode(), DES.MODE_CBC, <span class="built_in">bytes</span>(<span class="number">8</span>))</span><br><span class="line">    e2 = DES.new(k2.encode(), DES.MODE_CBC, <span class="built_in">bytes</span>(<span class="number">8</span>))</span><br><span class="line">    m = e1.decrypt(e2.encrypt(c))</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    words = <span class="string">&#x27;0123456789abcdef&#x27;</span></span><br><span class="line">    c_1 = base64.b64decode(<span class="string">&#x27;D4meWwYAUE4=&#x27;</span>)</span><br><span class="line">    c_2 = base64.b64decode(<span class="string">&#x27;qMMGe3wORmFJePnQnM2ZeA==&#x27;</span>)</span><br><span class="line">    words = its.product(words,repeat=<span class="number">4</span>)</span><br><span class="line">    mid_1 = []</span><br><span class="line">    mid_2 = []</span><br><span class="line">    key = []</span><br><span class="line">    k1 = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    k2 = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> words:</span><br><span class="line">        key.append(<span class="string">&#x27;&#x27;</span>.join(i))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> key:</span><br><span class="line">        m = enc(<span class="string">b&#x27;12345678&#x27;</span>, i * <span class="number">2</span>)</span><br><span class="line">        mid_1.append(m)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> key:</span><br><span class="line">        m = enc(c_1, i * <span class="number">2</span>)</span><br><span class="line">        mid_2.append(m)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> mid_1:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> mid_2:</span><br><span class="line">            <span class="keyword">if</span> i == j:</span><br><span class="line">                mid = i</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> key:</span><br><span class="line">        <span class="keyword">if</span> enc(<span class="string">b&#x27;12345678&#x27;</span>, i * <span class="number">2</span>) == mid:</span><br><span class="line">            k1 = i * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> key:</span><br><span class="line">        <span class="keyword">if</span> enc(c_1, i * <span class="number">2</span>) == mid:</span><br><span class="line">            k2 = i * <span class="number">2</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(dec(c_2, k1, k2))</span><br><span class="line"></span><br><span class="line"><span class="comment"># b&#x27;_Meet_in_Middle_&#x27;</span></span><br></pre></td></tr></table></figure>


    </div>

</div>
                <div class="footer">
    <span>Copyright © 2022 姜姜酱</span>
    <span>@QSANG</a></span>
</div>


<link rel="stylesheet" href="/css/a11y-dark.min.css">


<script src="/js/highlight.min.js"></script>


<script src="/js/highlightjs-line-numbers.js"></script>


<script>
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
</script>

            </div>
        </div>
    </body>
</html>